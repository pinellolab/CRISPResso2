{
  "id": "2152e3af",
  "title": "Refactor repo to use Pixi for environment management, Docker, and CI",
  "tags": [
    "refactor",
    "devops",
    "pixi",
    "docker",
    "ci"
  ],
  "status": "open",
  "created_at": "2026-02-11T18:47:04.568Z"
}

## Goal

Replace micromamba (Dockerfile) and conda/miniconda (GitHub Actions) with Pixi for unified tooling, better local dev experience, and reproducible environments. Pixi manages environments and tasks; `pyproject.toml` remains the package definition.

## Scope

### In scope
- Create `pixi.toml` at repo root
- Update `Dockerfile` to use Pixi
- Update `.github/workflows/pytest.yml` to use `prefix-dev/setup-pixi`
- Update `.github/workflows/integration_tests.yml` to use `prefix-dev/setup-pixi`
- Delete `.github/envs/test_env.yml`
- Update `.gitignore` (add `pixi.lock`, `.pixi/`)
- Update `CLAUDE.md` with new commands

### Out of scope
- `setup.py` cleanup / consolidation into `pyproject.toml` (separate task)
- `README.md` updates (deferred to docs website)
- `pylint.yml` and `aws_ecr.yml` changes (stay as-is)
- Committing `pixi.lock` (gitignored)

## Approach

### 1. `pixi.toml`

- **Channels**: `conda-forge`, `bioconda`
- **Platforms**: `linux-64`, `osx-64`, `osx-arm64`
- **Conda dependencies** (shared): `numpy <2`, `cython`, `scipy`, `matplotlib`, `seaborn`, `pandas >2`, `jinja2`, `tbb =2020.2`, `pyparsing =2.3.1`, `fastp`, `bowtie2`, `samtools`, `upsetplot`, `plotly`
- **PyPI dependencies**: the package itself via `pip install -e .`

**Environments**:
- `default` — all deps + dev tools (local development)
- `test` — adds `pytest`, `pytest-cov`, `pytest-check`, `ydiff`
- `lint` — adds `pylint` only

**Tasks**:
- `pixi run install` — `pip install -e .`
- `pixi run test` — `pytest tests --cov CRISPResso2` (test env)
- `pixi run lint` — pylint invocation (lint env)
- `pixi run integration <target>` — wraps `make <target> test` in `../CRISPResso2_tests`

### 2. Dockerfile

- Base image: use Pixi Docker image (e.g., `ghcr.io/prefix-dev/pixi`)
- Copy `pixi.toml` and `pyproject.toml` first (layer caching)
- `pixi install` to create environment
- Copy source, then `pixi run install` for `pip install -e .`
- Keep `apt-get` for `gcc`, `g++`, and MS core fonts
- `bowtie2` and `samtools` come from conda via Pixi (not apt)
- Smoke tests: `pixi run -- CRISPResso -h`, etc.
- Wrap entrypoint through `pixi run`

### 3. GitHub Actions

**`pytest.yml`**:
- Replace `conda-incubator/setup-miniconda` + `test_env.yml` with `prefix-dev/setup-pixi`
- Use `test` environment
- Steps: checkout → setup-pixi → `pixi run install` → `pixi run test`
- Keep `apt-get` for `gcc`, `g++` (Cython compilation)
- Remove `bowtie2`, `samtools`, `libsys-hostname-long-perl` from apt

**`integration_tests.yml`**:
- Same swap: replace setup-miniconda + conda caching with `prefix-dev/setup-pixi`
- Use `test` environment
- Remove manual conda env caching logic (Pixi/setup-pixi handles this)
- Keep matrix strategy and test structure as-is

### 4. Housekeeping

- `.gitignore`: add `pixi.lock`, `.pixi/`
- `CLAUDE.md`: update install and test commands to reference Pixi
- Delete `.github/envs/test_env.yml`

## Done when

- `pixi run install`, `pixi run test`, `pixi run lint` all work locally
- Dockerfile builds successfully with Pixi
- pytest and integration test workflows pass in GitHub Actions
- No remaining references to miniconda/micromamba in modified files
